"use strict";function createDiary(e){var t=e;parseInt(t.date.hour)<10&&(t.date.hour="0"+t.date.hour),parseInt(t.date.min)<10&&(t.date.min="0"+t.date.min),parseInt(t.date.day)<10&&(t.date.day="0"+t.date.day);var a=t.date.hour+":"+t.date.min,n=$('<div class="text"><p>'+t.text.replace(/\n/g,"\n  ")+"</p></div>"),i=$('<div class="footer"><div class="footer-date"><span class="time">'+a+'</span><span class="date">'+t.date.day+'日</span></div><div class="footer-btns"><i class="material-icons btn-edit">edit</i><i class="material-icons btn-delete">delete_forever</i></div></div>'),o=$('<div class="diary" id="'+t.id+'"></div>');return o.append(n).append(i),o}function createMonthlyBlock(e){var t=$('<div class="month"><span>'+e+'</span><i class="arrow material-icons">arrow_drop_up</i></div>'),a=$('<div class="diary-list"></div>'),n=$('<section class="monthly-block" id="'+e+'"></section>');n.append(t).append(a),$(".wrapper").append(n)}function handleDiaries(e){e.forEach(function(e){var t=e;parseInt(t.date.mon)<10&&(t.date.mon="0"+t.date.mon);var a=t.date.year+"-"+t.date.mon;0==$("#"+a).length&&createMonthlyBlock(a);var n=createDiary(e);$("#"+a+">.diary-list").append(n)})}function createIndexItem(e){var t=$('<i class="material-icons">label_outline</i>'),a=$("<span>"+e+"</span>"),n=$('<div class="index-item">');n.append(t).append(a),$(".index-panel").append(n)}window.sessionStorage.getItem("token")||location.replace("login.html");var address="123.207.96.127:3000";$(document).ready(function(){var e=$("#btn-logout"),t=$("#btn-hide"),a=$("#btn-new");e.click(function(){window.sessionStorage.removeItem("token"),location.replace("login.html")}),t.click(function(){$(".diary>.text>p").addBack().toggleClass("hide"),console.log($(this)),"visibility"==$(this).text()?$(this).text("visibility_off"):$(this).text("visibility")}),a.click(function(){$("main").addClass("blur"),$(".edit-panel").slideDown(500).find("textarea").val(""),$(".edit-panel>.textfield").attr("name","new-diary"),$(".textfield>textarea").focus().trigger("input")}),$("main").on("click",".monthly-block .arrow",function(){$(this).parent().next().slideToggle(),"arrow_drop_up"==$(this).text()?$(this).text("arrow_drop_down"):$(this).text("arrow_drop_up")}),$("main").on("click",".btn-edit",function(){var e=$(this).parentsUntil(".diary").parent().find(".text").children().text();$("main").addClass("blur"),$(".edit-panel").slideDown(500).find("textarea").val(e),$(".edit-panel>.textfield").attr("name","edit-diary").data("id",$(this).parents(".diary").attr("id")),$(".textfield>textarea").focus().trigger("input")}),$("main").on("click",".btn-delete",function(){window.confirm("确定要删除吗？")&&$.ajax({url:"http://"+address+"/diary/delete",type:"post",data:{token:window.sessionStorage.getItem("token"),id:$(this).parents(".diary").attr("id")},headers:{"Content-type":"application/x-www-form-urlencoded"},dataType:"json",statusCode:{401:function(){window.sessionStorage.removeItem("token"),location.replace("login.html")},200:function(){console.log("删除成功"),location.reload()}}})}),$("#btn-edit-cancel").on("click",function(){$(".edit-panel").slideUp(500),$("main").removeClass("blur")}),$("#btn-edit-done").on("click",function(){$(".edit-panel>.textfield").submit()}),$(".edit-panel").on("submit",'.textfield[name="new-diary"]',function(e){e.preventDefault(),$.ajax({url:"http://"+address+"/diary/add",type:"post",data:{token:window.sessionStorage.getItem("token"),text:$(".textfield>textarea").val()},headers:{"Content-type":"application/x-www-form-urlencoded"},dataType:"json",statusCode:{401:function(){window.sessionStorage.removeItem("token"),location.replace("login.html")},200:function(){console.log("提交成功"),location.reload()}}})}),$(".edit-panel").on("submit",'.textfield[name="edit-diary"]',function(e){e.preventDefault(),$.ajax({url:"http://"+address+"/diary/update",type:"post",data:{token:window.sessionStorage.getItem("token"),text:$(".textfield>textarea").val(),id:$(".textfield").data("id")},headers:{"Content-type":"application/x-www-form-urlencoded"},dataType:"json",statusCode:{401:function(){window.sessionStorage.removeItem("token"),location.replace("login.html")},200:function(){console.log("修改成功"),location.reload()}}})}),$(".textfield>textarea").on("input",function(){$(".edit-info>span").text($(this).val().length)}),$("main").on("click",".month span",function(){$("main").addClass("blur"),$(".month>span").each(function(){createIndexItem($(this).text())}),$(".index-panel").slideDown(500)}),$(".index-panel").on("click",".index-item",function(){var e=$(this).children("span").text();$(".index-panel").slideUp(500,function(){$("html,body").animate({scrollTop:$("#"+e).offset().top-60},500)}),$("main").removeClass("blur")}),$(".loading").on("click",function(){var e=parseInt($(".wrapper").data("page"))+1;$.ajax({url:"http://"+address+"/diaries/page/"+e,type:"post",data:{token:window.sessionStorage.getItem("token")},headers:{"Content-type":"application/x-www-form-urlencoded"},dataType:"json",beforeSend:function(){$(".loading>p").addClass("material-icons").text("cached")},complete:function(){$(".loading>p").removeClass("material-icons")},statusCode:{401:function(){window.sessionStorage.removeItem("token"),location.replace("login.html")},200:function(t){t.length?(handleDiaries(t),$(".wrapper").data("page",e),$(".loading>p").text("加载更多 ...")):$(".loading>p").text("没有更多啦😆")}}})}),$.ajax({url:"http://"+address+"/diaries/page/1",type:"post",data:{token:window.sessionStorage.getItem("token")},headers:{"Content-type":"application/x-www-form-urlencoded"},dataType:"json",success:function(e){handleDiaries(e),$(".wrapper").data("page",1)},statusCode:{401:function(){window.sessionStorage.removeItem("token"),location.replace("login.html")}}})});